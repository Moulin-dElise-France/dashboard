<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Le Moulin d'Elise — Carquefou</title>
<link rel="icon" href="https://moulindelise.com/wp-content/uploads/2024/03/cropped-logo-moulin-elise-01-1-32x32.png">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{
  --gold:#BF8D50;--gold-light:#d4a96a;--gold-dark:#a07640;--gold-bg:rgba(191,141,80,0.08);--gold-bg2:rgba(191,141,80,0.15);
  --wheat:#e8d5b7;--cream:#f5ead6;
  --trafic:#3498db;--engagement:#e67e22;--notoriete:#9b59b6;--recrutement:#27ae60;--leadgen:#c0392b;
  --text-primary:#1a1a1a;--text-secondary:#5a5a5a;--text-tertiary:#8a8a8a;
  --bg:#faf7f2;--bg-card:#ffffff;
  --border:rgba(0,0,0,0.06);--border-strong:rgba(0,0,0,0.1);
  --radius-sm:8px;--radius-md:12px;--radius-lg:16px;
  --shadow-sm:0 2px 8px rgba(0,0,0,0.05);--shadow-md:0 4px 16px rgba(0,0,0,0.08);
  --sidebar-w:260px;
}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:'Plus Jakarta Sans','Inter',sans-serif;background:var(--bg);color:var(--text-primary);overflow-x:hidden}
.dashboard{display:flex;min-height:100vh}

/* ══ SIDEBAR ══ */
.sidebar{width:var(--sidebar-w);background:var(--bg-card);border-right:1px solid var(--border);position:fixed;top:0;left:0;bottom:0;z-index:100;display:flex;flex-direction:column;overflow-y:auto}
.sidebar-brand{padding:20px 20px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);text-decoration:none;color:inherit}
.sidebar-logo{height:36px;width:auto}
.sidebar-brand-text h2{font-size:14px;font-weight:800;letter-spacing:-.2px}
.sidebar-brand-text span{font-size:10px;color:var(--text-tertiary);font-weight:600;text-transform:uppercase;letter-spacing:.8px}
.sidebar-nav{flex:1;padding:12px 10px}
.nav-section{margin-bottom:16px}
.nav-section-title{font-size:10px;font-weight:700;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:1px;padding:8px 12px 4px}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:var(--radius-sm);cursor:pointer;transition:all .2s;font-size:13px;font-weight:500;color:var(--text-secondary);border:none;background:none;width:100%;text-align:left;font-family:inherit}
.nav-item:hover{background:var(--gold-bg);color:var(--text-primary)}
.nav-item.active{background:var(--gold-bg2);color:var(--gold-dark);font-weight:700;border-left:3px solid var(--gold)}
.nav-item svg{width:18px;height:18px;flex-shrink:0;opacity:.6}
.nav-item.active svg{opacity:1;color:var(--gold)}
.sidebar-back{padding:16px 20px;border-top:1px solid var(--border)}
.sidebar-back a{display:flex;align-items:center;gap:8px;font-size:12px;font-weight:600;color:var(--text-tertiary);text-decoration:none;transition:color .2s}
.sidebar-back a:hover{color:var(--gold)}
.sidebar-back a svg{width:16px;height:16px}

/* ══ MAIN ══ */
.main{margin-left:var(--sidebar-w);flex:1;min-width:0}
.topbar{position:sticky;top:0;z-index:50;background:rgba(250,247,242,0.85);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between}
.topbar-left{display:flex;align-items:center;gap:12px}
.topbar-title{font-size:14px;font-weight:700;color:var(--text-primary)}
.topbar-sep{color:var(--text-tertiary);font-size:12px}
.topbar-page{font-size:14px;font-weight:500;color:var(--text-secondary)}
.live-dot{width:8px;height:8px;border-radius:50%;background:var(--recrutement);animation:blink 1.5s ease-in-out infinite;margin-right:4px;display:inline-block}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.topbar-right{display:flex;align-items:center;gap:12px}
.topbar-date{font-size:12px;color:var(--text-tertiary);font-weight:500}
.content{padding:24px 28px;max-width:1400px}

/* ══ STATUS BANNER ══ */
.status-banner{padding:10px 16px;border-radius:var(--radius-sm);margin-bottom:20px;font-size:12px;font-weight:600;display:flex;align-items:center;gap:8px}
.status-banner.ok{background:rgba(39,174,96,0.08);color:#27ae60;border:1px solid rgba(39,174,96,0.15)}
.status-banner.err{background:rgba(192,57,43,0.08);color:#c0392b;border:1px solid rgba(192,57,43,0.15)}
.status-banner svg{width:16px;height:16px;flex-shrink:0}

/* ══ PAGE VIEWS ══ */
.page-view{display:none}
.page-view.active{display:block;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

/* ══ KPI GRID ══ */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-bottom:24px}
.kpi-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:18px;position:relative;transition:all .25s}
.kpi-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-sm)}
.kpi-card::after{content:'';position:absolute;top:0;left:0;right:0;height:2.5px;border-radius:var(--radius-md) var(--radius-md) 0 0;background:var(--gold);opacity:0;transition:opacity .25s}
.kpi-card:hover::after{opacity:1}
.kpi-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.kpi-label{font-size:11px;font-weight:700;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:.6px}
.kpi-icon{width:34px;height:34px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center}
.kpi-icon svg{width:16px;height:16px}
.kpi-icon.gold{background:var(--gold-bg2);color:var(--gold)}
.kpi-icon.blue{background:rgba(52,152,219,0.1);color:var(--trafic)}
.kpi-icon.orange{background:rgba(230,126,34,0.1);color:var(--engagement)}
.kpi-icon.red{background:rgba(192,57,43,0.1);color:var(--leadgen)}
.kpi-icon.green{background:rgba(39,174,96,0.1);color:var(--recrutement)}
.kpi-value{font-size:26px;font-weight:800;letter-spacing:-.5px;line-height:1.1}
.kpi-sub{font-size:11px;color:var(--text-tertiary);margin-top:4px}

/* ══ SECTION TITLE ══ */
.sec-title{font-size:16px;font-weight:800;margin-bottom:4px;letter-spacing:-.2px}
.sec-sub{font-size:12px;color:var(--text-tertiary);margin-bottom:16px}

/* ══ CHARTS ══ */
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}
.chart-box{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:18px}
.chart-box-title{font-size:12px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px}
.chart-container{position:relative;height:260px}
.chart-container.sm{height:200px}

/* ══ CAMPAIGN FILTER PILLS ══ */
.filter-pills{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:20px}
.pill{font-family:inherit;font-size:12px;font-weight:600;padding:6px 14px;border:1px solid var(--border-strong);background:var(--bg-card);color:var(--text-secondary);cursor:pointer;border-radius:20px;transition:all .2s}
.pill:hover{border-color:var(--gold);color:var(--gold)}
.pill.active{background:var(--gold);color:#fff;border-color:var(--gold)}
.pill .dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}

/* ══ DATA TABLE ══ */
.data-table{width:100%;border-collapse:separate;border-spacing:0;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);overflow:hidden;margin-bottom:24px}
.data-table thead th{font-size:10px;font-weight:700;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:.5px;padding:12px 12px;text-align:right;background:var(--bg);border-bottom:1px solid var(--border)}
.data-table thead th:first-child{text-align:left;padding-left:16px}
.data-table tbody td{font-size:13px;font-weight:500;padding:10px 12px;text-align:right;border-bottom:1px solid var(--border);font-variant-numeric:tabular-nums}
.data-table tbody td:first-child{text-align:left;font-weight:600;padding-left:16px}
.data-table tbody tr:last-child td{border-bottom:none}
.data-table tbody tr:hover td{background:var(--gold-bg)}
.data-table tfoot td{font-size:13px;font-weight:800;padding:12px 12px;text-align:right;background:var(--gold-bg);border-top:2px solid var(--gold)}
.data-table tfoot td:first-child{text-align:left;padding-left:16px;color:var(--gold-dark)}
td.cost{color:#c0392b}
td.leads{color:var(--gold);font-weight:700}
.camp-badge{display:inline-block;font-size:9px;font-weight:700;padding:2px 8px;border-radius:10px;text-transform:uppercase;letter-spacing:.3px}
.camp-badge.trafic{background:rgba(52,152,219,0.1);color:var(--trafic)}
.camp-badge.engagement{background:rgba(230,126,34,0.1);color:var(--engagement)}
.camp-badge.notoriete{background:rgba(155,89,182,0.1);color:var(--notoriete)}
.camp-badge.recrutement{background:rgba(39,174,96,0.1);color:var(--recrutement)}
.camp-badge.leadgen{background:rgba(192,57,43,0.1);color:var(--leadgen)}

/* ══ CALENDAR ══ */
.cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.cal-title{font-size:16px;font-weight:700}
.cal-nav{display:flex;gap:8px}
.cal-nav button{width:32px;height:32px;border:1px solid var(--border-strong);background:var(--bg-card);border-radius:var(--radius-sm);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;color:var(--text-secondary);font-family:inherit}
.cal-nav button:hover{border-color:var(--gold);color:var(--gold)}
.cal-nav button:disabled{opacity:.3;cursor:default}

/* ══ CONNEXION PAGE ══ */
.conn-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:20px;margin-bottom:16px}
.conn-title{font-size:14px;font-weight:700;margin-bottom:12px}
.conn-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px}
.conn-row:last-child{border-bottom:none}
.conn-label{color:var(--text-secondary);font-weight:500}
.conn-val{font-weight:700;font-variant-numeric:tabular-nums}
.conn-status{display:inline-flex;align-items:center;gap:6px;font-size:11px;font-weight:700;padding:3px 10px;border-radius:12px}
.conn-status.ok{background:rgba(39,174,96,0.1);color:#27ae60}

/* ══ MOBILE OVERLAY ══ */
.mobile-toggle{display:none;position:fixed;bottom:20px;right:20px;z-index:200;width:48px;height:48px;border-radius:50%;background:var(--gold);color:#fff;border:none;box-shadow:var(--shadow-md);cursor:pointer;align-items:center;justify-content:center}
.mobile-toggle svg{width:22px;height:22px}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:90}

@media(max-width:768px){
  .sidebar{transform:translateX(-100%);transition:transform .3s;z-index:200}
  .sidebar.open{transform:none}
  .sidebar-overlay.open{display:block}
  .main{margin-left:0}
  .mobile-toggle{display:flex}
  .topbar{padding:12px 16px}
  .content{padding:16px}
  .kpi-grid{grid-template-columns:1fr 1fr}
  .charts-grid{grid-template-columns:1fr}
  .chart-container{height:220px}
}
@media(max-width:480px){
  .kpi-grid{grid-template-columns:1fr}
  .kpi-value{font-size:22px}
}
</style>
</head>
<body>

<div class="dashboard">

<!-- ══ SIDEBAR ══ -->
<aside class="sidebar" id="sidebar">
  <a class="sidebar-brand" href="portail-moulin-elise.html">
    <img class="sidebar-logo" src="https://moulindelise.com/wp-content/uploads/logo-moulin-elise-01.svg" alt="Logo">
    <div class="sidebar-brand-text">
      <h2>Le Moulin d'Elise</h2>
      <span>Carquefou</span>
    </div>
  </a>
  <nav class="sidebar-nav">
    <div class="nav-section">
      <div class="nav-section-title">Tableau de bord</div>
      <button class="nav-item active" data-page="overview">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
        Vue d'ensemble
      </button>
      <button class="nav-item" data-page="performances">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
        Performances
      </button>
    </div>
    <div class="nav-section">
      <div class="nav-section-title">Campagnes</div>
      <button class="nav-item" data-page="campaigns">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
        Meta Ads
      </button>
    </div>
    <div class="nav-section">
      <div class="nav-section-title">Donnees</div>
      <button class="nav-item" data-page="calendar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        Calendrier
      </button>
      <button class="nav-item" data-page="connexions">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
        Connexions
      </button>
    </div>
  </nav>
  <div class="sidebar-back">
    <a href="portail-moulin-elise.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
      Retour au portail
    </a>
  </div>
</aside>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<!-- ══ MAIN ══ -->
<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <span class="topbar-title">Carquefou</span>
      <span class="topbar-sep">/</span>
      <span class="topbar-page" id="breadcrumb">Vue d'ensemble</span>
    </div>
    <div class="topbar-right">
      <span class="live-dot"></span>
      <span class="topbar-date" id="topbarDate"></span>
    </div>
  </div>

  <div class="content">
    <div class="status-banner ok" id="statusBanner" style="display:none">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
      <span id="statusText"></span>
    </div>

    <!-- PAGE: VUE D'ENSEMBLE -->
    <div class="page-view active" id="page-overview">
      <div class="kpi-grid" id="overviewKpis"></div>
      <div class="charts-grid">
        <div class="chart-box"><div class="chart-box-title">Impressions par jour</div><div class="chart-container"><canvas id="chartImpDay"></canvas></div></div>
        <div class="chart-box"><div class="chart-box-title">Clics par jour</div><div class="chart-container"><canvas id="chartClkDay"></canvas></div></div>
        <div class="chart-box"><div class="chart-box-title">Depenses par jour</div><div class="chart-container"><canvas id="chartCostDay"></canvas></div></div>
        <div class="chart-box"><div class="chart-box-title">Leads par jour</div><div class="chart-container"><canvas id="chartLeadsDay"></canvas></div></div>
      </div>
      <div class="chart-box" style="margin-bottom:24px"><div class="chart-box-title">Repartition des depenses par campagne</div><div class="chart-container"><canvas id="chartCostPie"></canvas></div></div>
    </div>

    <!-- PAGE: PERFORMANCES -->
    <div class="page-view" id="page-performances">
      <h3 class="sec-title">Performances detaillees</h3>
      <p class="sec-sub">Donnees agregees par campagne, triees par depenses</p>
      <table class="data-table" id="perfTable"><thead></thead><tbody></tbody><tfoot></tfoot></table>
    </div>

    <!-- PAGE: CAMPAIGNS (META ADS DETAIL) -->
    <div class="page-view" id="page-campaigns">
      <h3 class="sec-title">Meta Ads — Detail par campagne</h3>
      <p class="sec-sub">Filtrez par type de campagne</p>
      <div class="filter-pills" id="campFilters"></div>
      <div class="kpi-grid" id="campKpis"></div>
      <div class="charts-grid">
        <div class="chart-box"><div class="chart-box-title">Impressions (filtre)</div><div class="chart-container"><canvas id="chartCampImp"></canvas></div></div>
        <div class="chart-box"><div class="chart-box-title">Clics (filtre)</div><div class="chart-container"><canvas id="chartCampClk"></canvas></div></div>
      </div>
      <table class="data-table" id="campTable"><thead></thead><tbody></tbody><tfoot></tfoot></table>
    </div>

    <!-- PAGE: CALENDAR -->
    <div class="page-view" id="page-calendar">
      <h3 class="sec-title">Calendrier jour par jour</h3>
      <p class="sec-sub">Navigation mensuelle avec detail quotidien</p>
      <div class="filter-pills" id="calFilters"></div>
      <div class="cal-header">
        <span class="cal-title" id="calTitle"></span>
        <div class="cal-nav">
          <button id="calPrev" onclick="changeMonth(-1)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
          <button id="calNext" onclick="changeMonth(1)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></button>
        </div>
      </div>
      <table class="data-table" id="calTable"><thead></thead><tbody></tbody><tfoot></tfoot></table>
    </div>

    <!-- PAGE: CONNEXIONS -->
    <div class="page-view" id="page-connexions">
      <h3 class="sec-title">Connexions & Sources</h3>
      <p class="sec-sub">Statut des sources de donnees</p>
      <div class="conn-card">
        <div class="conn-title">Google Sheets — Supermetrics</div>
        <div class="conn-row"><span class="conn-label">Onglet</span><span class="conn-val">CARQUEFOU</span></div>
        <div class="conn-row"><span class="conn-label">GID</span><span class="conn-val">699035284</span></div>
        <div class="conn-row"><span class="conn-label">Statut</span><span class="conn-status ok" id="connStatus">Connecte</span></div>
        <div class="conn-row"><span class="conn-label">Derniere donnee</span><span class="conn-val" id="connLastDate">--</span></div>
        <div class="conn-row"><span class="conn-label">Lignes chargees</span><span class="conn-val" id="connRows">--</span></div>
      </div>
      <div class="conn-card">
        <div class="conn-title">Informations client</div>
        <div class="conn-row"><span class="conn-label">Client</span><span class="conn-val">Le Moulin d'Elise</span></div>
        <div class="conn-row"><span class="conn-label">Entite</span><span class="conn-val">Carquefou (44)</span></div>
        <div class="conn-row"><span class="conn-label">Site web</span><span class="conn-val"><a href="https://moulindelise.com" target="_blank" style="color:var(--gold)">moulindelise.com</a></span></div>
        <div class="conn-row"><span class="conn-label">Version dashboard</span><span class="conn-val">1.0</span></div>
      </div>
    </div>

  </div>
</div>

</div>

<button class="mobile-toggle" onclick="toggleSidebar()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>

<script>
/* ══════════════════════════════════════════════
   LE MOULIN D'ELISE — DASHBOARD CARQUEFOU
   ══════════════════════════════════════════════ */
Chart.defaults.font.family="'Plus Jakarta Sans','Inter',sans-serif";
const CSV_URL='https://docs.google.com/spreadsheets/d/e/2PACX-1vQZZqBeck80LcNEZUPOx-EjBHY_xnR1yGINcHIllM-P7lBh_rT1zdZTLxp6nyOE06ppyCagPog6Dxx1/pub?output=csv&single=true&gid=699035284';
const MONTHS_FR=['Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre'];
const TYPE_DETECT=[
  {type:'LeadGen',cls:'leadgen',color:'#c0392b',match:['leadgen','lead_gen','lead gen']},
  {type:'Trafic',cls:'trafic',color:'#3498db',match:['trafic']},
  {type:'Engagement',cls:'engagement',color:'#e67e22',match:['engagement']},
  {type:'Notoriete',cls:'notoriete',color:'#9b59b6',match:['notori']},
  {type:'Recrutement',cls:'recrutement',color:'#27ae60',match:['recrutement']}
];
const charts={};
let allRows=[],byDate={},byCamp={},allMonths=[],currentMonth='',calFilter='Toutes',campFilter='Toutes';

/* ── CSV ── */
function parseCSV(text){const lines=text.trim().split('\n');if(lines.length<2)return[];const h=parseLine(lines[0]);const rows=[];for(let i=1;i<lines.length;i++){const v=parseLine(lines[i]);if(v.length<h.length)continue;const r={};h.forEach((k,j)=>r[k.trim()]=v[j]);rows.push(r)}return rows}
function parseLine(l){const r=[];let c='',q=false;for(let i=0;i<l.length;i++){const ch=l[i];if(ch==='"'){if(q&&l[i+1]==='"'){c+='"';i++}else q=!q}else if(ch===','&&!q){r.push(c);c=''}else c+=ch}r.push(c);return r}
function pN(v){if(!v||v==='')return 0;return parseFloat(String(v).replace(/"/g,'').replace(',','.').replace(/\s/g,''))||0}
function detectType(name){const n=name.toLowerCase();for(const d of TYPE_DETECT){if(d.match.some(m=>n.includes(m)))return d.type}return'Autre'}
function fmt(n){return n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?Math.round(n).toLocaleString('fr-FR'):String(Math.round(n))}
function fmtE(n){return n.toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' \u20ac'}
function fmtPct(n){return n.toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' %'}

/* ── PROCESS DATA ── */
function processData(rows){
  allRows=rows;byDate={};byCamp={};
  rows.forEach(r=>{
    const date=r['Date'];const name=r['Campaign name']||'';const type=detectType(name);
    const entry={date,name,type,impressions:pN(r['Impressions']),reach:pN(r['Reach']),clicks:pN(r['Clicks (all)']),cost:pN(r['Cost (EUR)']),ctr:pN(r['CTR (link click-through rate)']),video50:pN(r['Video watches at 50%']),video100:pN(r['Video watches at 100%']),leads:pN(r['On-Facebook leads']),reactions:pN(r['Post reactions'])};
    if(!byDate[date])byDate[date]={};
    if(!byDate[date][type])byDate[date][type]={impressions:0,clicks:0,cost:0,leads:0,reactions:0,reach:0};
    const dd=byDate[date][type];dd.impressions+=entry.impressions;dd.clicks+=entry.clicks;dd.cost+=entry.cost;dd.leads+=entry.leads;dd.reactions+=entry.reactions;dd.reach+=entry.reach;
    if(!byDate[date]._all)byDate[date]._all={impressions:0,clicks:0,cost:0,leads:0,reactions:0};
    const da=byDate[date]._all;da.impressions+=entry.impressions;da.clicks+=entry.clicks;da.cost+=entry.cost;da.leads+=entry.leads;da.reactions+=entry.reactions;
    if(!byCamp[type])byCamp[type]={impressions:0,clicks:0,cost:0,leads:0,reactions:0,reach:0,entries:[]};
    const bc=byCamp[type];bc.impressions+=entry.impressions;bc.clicks+=entry.clicks;bc.cost+=entry.cost;bc.leads+=entry.leads;bc.reactions+=entry.reactions;bc.reach+=entry.reach;bc.entries.push(entry);
  });
  const dates=Object.keys(byDate).sort();
  allMonths=[...new Set(dates.map(d=>d.substring(0,7)))].sort();
  currentMonth=allMonths[allMonths.length-1]||'2026-02';
}

/* ── LOAD ── */
async function loadData(){
  try{
    const resp=await fetch(CSV_URL+'&_t='+Date.now(),{redirect:'follow',credentials:'omit'});
    if(!resp.ok)throw new Error('HTTP '+resp.status);
    const text=await resp.text();
    const rows=parseCSV(text);
    if(rows.length===0)throw new Error('Aucune donnee');
    processData(rows);
    const banner=document.getElementById('statusBanner');
    banner.style.display='flex';banner.className='status-banner ok';
    const dates=Object.keys(byDate).sort();
    document.getElementById('statusText').textContent=rows.length+' lignes chargees \u00b7 Derniere donnee: '+dates[dates.length-1];
    document.getElementById('connLastDate').textContent=dates[dates.length-1];
    document.getElementById('connRows').textContent=rows.length;
    renderAll();
  }catch(e){
    console.error(e);
    const banner=document.getElementById('statusBanner');
    banner.style.display='flex';banner.className='status-banner err';
    document.getElementById('statusText').textContent='Erreur: '+e.message;
  }
}

function renderAll(){
  renderOverviewKPIs();renderOverviewCharts();renderPerformanceTable();renderCampaignPage();renderCalendarFilters();renderCalendar();
}

/* ── OVERVIEW KPIs ── */
function renderOverviewKPIs(){
  let imp=0,clk=0,cost=0,leads=0,react=0,reach=0;
  allRows.forEach(r=>{imp+=pN(r['Impressions']);clk+=pN(r['Clicks (all)']);cost+=pN(r['Cost (EUR)']);leads+=pN(r['On-Facebook leads']);react+=pN(r['Post reactions']);reach+=pN(r['Reach'])});
  document.getElementById('overviewKpis').innerHTML=`
    <div class="kpi-card"><div class="kpi-header"><span class="kpi-label">Impressions</span><div class="kpi-icon gold"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></div></div><div class="kpi-value">${fmt(imp)}</div><div class="kpi-sub">Portee: ${fmt(reach)}</div></div>
    <div class="kpi-card"><div class="kpi-header"><span class="kpi-label">Clics</span><div class="kpi-icon blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg></div></div><div class="kpi-value">${fmt(clk)}</div><div class="kpi-sub">CTR moy: ${imp?fmtPct(clk/imp*100):'--'}</div></div>
    <div class="kpi-card"><div class="kpi-header"><span class="kpi-label">Depenses</span><div class="kpi-icon orange"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></div></div><div class="kpi-value">${fmtE(cost)}</div><div class="kpi-sub">CPC moy: ${clk?fmtE(cost/clk):'--'}</div></div>
    <div class="kpi-card"><div class="kpi-header"><span class="kpi-label">Leads</span><div class="kpi-icon red"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div></div><div class="kpi-value">${fmt(leads)}</div><div class="kpi-sub">CPL moy: ${leads?fmtE(cost/leads):'--'}</div></div>
    <div class="kpi-card"><div class="kpi-header"><span class="kpi-label">Reactions</span><div class="kpi-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg></div></div><div class="kpi-value">${fmt(react)}</div><div class="kpi-sub">Engagement global</div></div>
  `;
}

/* ── OVERVIEW CHARTS ── */
function renderOverviewCharts(){
  const dates=Object.keys(byDate).sort();
  const labels=dates.map(d=>{const p=d.split('-');return p[2]+'/'+p[1]});
  const impData=dates.map(d=>byDate[d]._all?.impressions||0);
  const clkData=dates.map(d=>byDate[d]._all?.clicks||0);
  const costData=dates.map(d=>byDate[d]._all?.cost||0);
  const leadsData=dates.map(d=>byDate[d]._all?.leads||0);

  makeChart('chartImpDay','bar',labels,[{label:'Impressions',data:impData,backgroundColor:'rgba(191,141,80,0.5)',borderColor:'#BF8D50',borderWidth:1,borderRadius:3}]);
  makeChart('chartClkDay','bar',labels,[{label:'Clics',data:clkData,backgroundColor:'rgba(52,152,219,0.5)',borderColor:'#3498db',borderWidth:1,borderRadius:3}]);
  makeChart('chartCostDay','line',labels,[{label:'Depenses (EUR)',data:costData,borderColor:'#c0392b',backgroundColor:'rgba(192,57,43,0.08)',fill:true,tension:.3,pointRadius:1}]);
  makeChart('chartLeadsDay','bar',labels,[{label:'Leads',data:leadsData,backgroundColor:'rgba(192,57,43,0.5)',borderColor:'#c0392b',borderWidth:1,borderRadius:3}]);

  const campTypes=Object.keys(byCamp);
  const pieLabels=campTypes;
  const pieData=campTypes.map(t=>Math.round(byCamp[t].cost*100)/100);
  const pieColors=campTypes.map(t=>{const d=TYPE_DETECT.find(x=>x.type===t);return d?d.color:'#999'});
  makeChart('chartCostPie','doughnut',pieLabels,[{data:pieData,backgroundColor:pieColors,borderWidth:0}],{},{cutout:'65%',plugins:{legend:{position:'bottom',labels:{padding:16,usePointStyle:true,font:{size:12}}}}});
}

function makeChart(id,type,labels,datasets,scaleOpts={},extra={}){
  if(charts[id]){charts[id].destroy();delete charts[id]}
  const ctx=document.getElementById(id);if(!ctx)return;
  const isDoughnut=type==='doughnut';
  const config={type,data:{labels,datasets},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:isDoughnut},tooltip:{backgroundColor:'#1a1a1a',titleFont:{size:11},bodyFont:{size:11},padding:10,cornerRadius:8}},scales:isDoughnut?{}:{x:{grid:{display:false},ticks:{font:{size:10},maxRotation:0,autoSkip:true,maxTicksLimit:15}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{size:10}}}}},...extra};
  charts[id]=new Chart(ctx,config);
}

/* ── PERFORMANCE TABLE ── */
function renderPerformanceTable(){
  const types=Object.keys(byCamp).sort((a,b)=>byCamp[b].cost-byCamp[a].cost);
  const thead=document.querySelector('#perfTable thead');
  thead.innerHTML='<tr><th>Campagne</th><th>Impressions</th><th>Clics</th><th>CTR</th><th>Depenses</th><th>Leads</th><th>CPL</th><th>Reactions</th></tr>';
  const tbody=document.querySelector('#perfTable tbody');
  tbody.innerHTML='';
  let tImp=0,tClk=0,tCost=0,tLeads=0,tReact=0;
  types.forEach(type=>{
    const c=byCamp[type];tImp+=c.impressions;tClk+=c.clicks;tCost+=c.cost;tLeads+=c.leads;tReact+=c.reactions;
    const det=TYPE_DETECT.find(d=>d.type===type);
    const cls=det?det.cls:'';
    const ctr=c.impressions?fmtPct(c.clicks/c.impressions*100):'--';
    const cpl=c.leads?fmtE(c.cost/c.leads):'--';
    tbody.innerHTML+=`<tr><td><span class="camp-badge ${cls}">${type}</span></td><td>${fmt(c.impressions)}</td><td>${fmt(c.clicks)}</td><td>${ctr}</td><td class="cost">${fmtE(c.cost)}</td><td class="leads">${fmt(c.leads)}</td><td>${cpl}</td><td>${fmt(c.reactions)}</td></tr>`;
  });
  const tfoot=document.querySelector('#perfTable tfoot');
  const tCtr=tImp?fmtPct(tClk/tImp*100):'--';
  const tCpl=tLeads?fmtE(tCost/tLeads):'--';
  tfoot.innerHTML=`<tr><td>Total</td><td>${fmt(tImp)}</td><td>${fmt(tClk)}</td><td>${tCtr}</td><td class="cost">${fmtE(tCost)}</td><td class="leads">${fmt(tLeads)}</td><td>${tCpl}</td><td>${fmt(tReact)}</td></tr>`;
}

/* ── CAMPAIGN PAGE ── */
function renderCampaignPage(){
  const types=Object.keys(byCamp);
  let html='<button class="pill active" onclick="setCampFilter(\'Toutes\')">Toutes</button>';
  types.forEach(t=>{
    const det=TYPE_DETECT.find(d=>d.type===t);
    html+=`<button class="pill" onclick="setCampFilter('${t}')"><span class="dot" style="background:${det?det.color:'#999'}"></span>${t}</button>`;
  });
  document.getElementById('campFilters').innerHTML=html;
  renderCampDetail();
}
function setCampFilter(f){
  campFilter=f;
  document.querySelectorAll('#campFilters .pill').forEach(b=>b.classList.toggle('active',b.textContent.trim()===f||(!b.querySelector('.dot')&&f==='Toutes')));
  renderCampDetail();
}
function renderCampDetail(){
  const types=campFilter==='Toutes'?Object.keys(byCamp):[campFilter];
  let imp=0,clk=0,cost=0,leads=0;
  types.forEach(t=>{if(byCamp[t]){imp+=byCamp[t].impressions;clk+=byCamp[t].clicks;cost+=byCamp[t].cost;leads+=byCamp[t].leads}});
  document.getElementById('campKpis').innerHTML=`
    <div class="kpi-card"><div class="kpi-header"><span class="kpi-label">Impressions</span></div><div class="kpi-value">${fmt(imp)}</div></div>
    <div class="kpi-card"><div class="kpi-header"><span class="kpi-label">Clics</span></div><div class="kpi-value">${fmt(clk)}</div></div>
    <div class="kpi-card"><div class="kpi-header"><span class="kpi-label">Depenses</span></div><div class="kpi-value">${fmtE(cost)}</div></div>
    <div class="kpi-card"><div class="kpi-header"><span class="kpi-label">Leads</span></div><div class="kpi-value">${fmt(leads)}</div></div>
  `;
  const dates=Object.keys(byDate).sort();
  const labels=dates.map(d=>{const p=d.split('-');return p[2]+'/'+p[1]});
  const impArr=dates.map(d=>{let v=0;types.forEach(t=>{if(byDate[d][t])v+=byDate[d][t].impressions});return v});
  const clkArr=dates.map(d=>{let v=0;types.forEach(t=>{if(byDate[d][t])v+=byDate[d][t].clicks});return v});
  makeChart('chartCampImp','bar',labels,[{label:'Impressions',data:impArr,backgroundColor:'rgba(191,141,80,0.5)',borderColor:'#BF8D50',borderWidth:1,borderRadius:3}]);
  makeChart('chartCampClk','bar',labels,[{label:'Clics',data:clkArr,backgroundColor:'rgba(52,152,219,0.5)',borderColor:'#3498db',borderWidth:1,borderRadius:3}]);

  const thead=document.querySelector('#campTable thead');
  thead.innerHTML='<tr><th>Date</th><th>Campagne</th><th>Impressions</th><th>Clics</th><th>Depenses</th><th>Leads</th><th>Reactions</th></tr>';
  const tbody=document.querySelector('#campTable tbody');
  tbody.innerHTML='';
  const filtered=allRows.filter(r=>types.includes(detectType(r['Campaign name']||'')));
  const last30=filtered.slice(-60);
  let tI=0,tC=0,tCo=0,tL=0,tR=0;
  last30.forEach(r=>{
    const type=detectType(r['Campaign name']||'');
    const det=TYPE_DETECT.find(d=>d.type===type);
    const i=pN(r['Impressions']),c=pN(r['Clicks (all)']),co=pN(r['Cost (EUR)']),l=pN(r['On-Facebook leads']),re=pN(r['Post reactions']);
    tI+=i;tC+=c;tCo+=co;tL+=l;tR+=re;
    tbody.innerHTML+=`<tr><td>${r['Date']}</td><td><span class="camp-badge ${det?det.cls:''}">${type}</span></td><td>${fmt(i)}</td><td>${fmt(c)}</td><td class="cost">${fmtE(co)}</td><td class="leads">${l||'-'}</td><td>${re||'-'}</td></tr>`;
  });
  const tfoot=document.querySelector('#campTable tfoot');
  tfoot.innerHTML=`<tr><td colspan="2">Total (${last30.length} lignes)</td><td>${fmt(tI)}</td><td>${fmt(tC)}</td><td class="cost">${fmtE(tCo)}</td><td class="leads">${fmt(tL)}</td><td>${fmt(tR)}</td></tr>`;
}

/* ── CALENDAR ── */
function renderCalendarFilters(){
  const types=Object.keys(byCamp);
  let html='<button class="pill active" onclick="setCalFilter(\'Toutes\')">Toutes</button>';
  types.forEach(t=>{
    const det=TYPE_DETECT.find(d=>d.type===t);
    html+=`<button class="pill" onclick="setCalFilter('${t}')"><span class="dot" style="background:${det?det.color:'#999'}"></span>${t}</button>`;
  });
  document.getElementById('calFilters').innerHTML=html;
}
function setCalFilter(f){
  calFilter=f;
  document.querySelectorAll('#calFilters .pill').forEach(b=>b.classList.toggle('active',b.textContent.trim()===f||(!b.querySelector('.dot')&&f==='Toutes')));
  renderCalendar();
}
function changeMonth(delta){
  const idx=allMonths.indexOf(currentMonth);const ni=idx+delta;
  if(ni<0||ni>=allMonths.length)return;
  currentMonth=allMonths[ni];renderCalendar();
}
function renderCalendar(){
  if(!currentMonth)return;
  const [y,m]=currentMonth.split('-').map(Number);
  const daysInMonth=new Date(y,m,0).getDate();
  const monthName=MONTHS_FR[m-1]+' '+y;
  document.getElementById('calTitle').textContent=monthName;
  const idx=allMonths.indexOf(currentMonth);
  document.getElementById('calPrev').disabled=(idx<=0);
  document.getElementById('calNext').disabled=(idx>=allMonths.length-1);

  const types=calFilter==='Toutes'?Object.keys(byCamp):[calFilter];
  const showLeads=types.includes('LeadGen');
  const cols=['Impressions','Clics','Depenses','Reactions'];
  if(showLeads)cols.push('Leads');

  document.querySelector('#calTable thead').innerHTML='<tr><th>Jour</th>'+cols.map(c=>'<th>'+c+'</th>').join('')+'</tr>';
  const tbody=document.querySelector('#calTable tbody');tbody.innerHTML='';
  const totals={imp:0,clk:0,cost:0,react:0,leads:0};

  for(let day=1;day<=daysInMonth;day++){
    const ds=y+'-'+String(m).padStart(2,'0')+'-'+String(day).padStart(2,'0');
    const dd=byDate[ds];
    let imp=0,clk=0,cost=0,react=0,leads=0;
    if(dd)types.forEach(t=>{if(dd[t]){imp+=dd[t].impressions;clk+=dd[t].clicks;cost+=dd[t].cost;react+=dd[t].reactions;leads+=dd[t].leads}});
    const has=imp>0||clk>0||cost>0;
    if(has){totals.imp+=imp;totals.clk+=clk;totals.cost+=cost;totals.react+=react;totals.leads+=leads}
    const dl=String(day).padStart(2,'0')+' '+MONTHS_FR[m-1].substring(0,3);
    let tds=`<td>${dl}</td><td>${has?fmt(imp):'-'}</td><td>${has?fmt(clk):'-'}</td><td class="cost">${has?fmtE(cost):'-'}</td><td>${has?fmt(react):'-'}</td>`;
    if(showLeads)tds+=`<td class="leads">${has&&leads?fmt(leads):'-'}</td>`;
    tbody.innerHTML+=`<tr${has?'':' style="opacity:.4"'}>${tds}</tr>`;
  }
  const tfoot=document.querySelector('#calTable tfoot');
  let ftds=`<td>Total ${monthName}</td><td>${fmt(totals.imp)}</td><td>${fmt(totals.clk)}</td><td class="cost">${fmtE(totals.cost)}</td><td>${fmt(totals.react)}</td>`;
  if(showLeads)ftds+=`<td class="leads">${fmt(totals.leads)}</td>`;
  tfoot.innerHTML=`<tr>${ftds}</tr>`;
}

/* ── NAVIGATION ── */
document.querySelectorAll('.nav-item[data-page]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.page-view').forEach(p=>p.classList.remove('active'));
    document.getElementById('page-'+btn.dataset.page).classList.add('active');
    document.getElementById('breadcrumb').textContent=btn.textContent.trim();
    if(window.innerWidth<=768)toggleSidebar();
  });
});
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('open');
}

/* ── DATE ── */
const now=new Date();
document.getElementById('topbarDate').textContent=now.toLocaleDateString('fr-FR',{day:'numeric',month:'long',year:'numeric'});

/* ── INIT ── */
loadData();
</script>
</body>
</html>
